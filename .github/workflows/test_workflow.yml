name: test workflow

run-name: Deploying solution from dev to test environment


on:
  workflow_dispatch:
    inputs:
      solution_name:
        description: 'Solution unique name (not display name).'
        required: true

env:
  # Azure AD / Service Principal (store as repo secrets)
  AZURE_TENANT_ID: ${{ secrets.PP_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.PP_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.PP_CLIENT_SECRET }}

  # Environments (store as repo secrets)
  DEV_ENV_URL: 'https://org23b23f97.crm.dynamics.com'     # e.g. https://org-<id>.crm.dynamics.com
  TEST_ENV_URL: 'https://orgd93932c9.crm.dynamics.com'

  # Local folder structure on the runner (you can change these)
  EXPORT_FOLDER: ./exported                 # where CLI writes the exported zip(s)
  DEPLOY_FOLDER: ./deploy                   # staging folder used before import
  SOLUTION_FOLDER: ./exported/solutions     # generic solution folder path
  MANAGED_FOLDER: ./exported/managed        # store managed zip here
  UNPACKED_FOLDER: ./exported/unpacked     # unpacked folder (if using pac unpack or unzip)

  # Output zip filename (will use solution_name input + suffix)
  SOLUTION_ZIP_NAME: ${{ github.event.inputs.solution_name }}.managed.zip


jobs:
  first-job:
    runs-on: ubuntu-latest

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        lfs: true

    - name: Ensure folders exist
      run: |
        echo "Creating folder structure on runner..."
        mkdir -p "${{ env.EXPORT_FOLDER }}" "${{ env.MANAGED_FOLDER }}" "${{ env.UNPACKED_FOLDER }}" "${{ env.DEPLOY_FOLDER }}"
        ls -la

    - name: Install Power Platform CLI / Tools
      # installs the pac wrapper and related tooling used by the export/import actions
      uses: microsoft/powerplatform-actions/actions-install@v1


    #- name: Create output directory
    #  run: mkdir -p out
      
    # -----------------------
    # EXPORT (Dev) -> Managed ZIP
    # -----------------------
    - name: Export managed solution from Dev
      uses: microsoft/powerplatform-actions/export-solution@v1
      with:
        environment-url: ${{ env.DEV_ENV_URL }}
        app-id: ${{ env.AZURE_CLIENT_ID }}
        client-secret: ${{ env.AZURE_CLIENT_SECRET }}
        tenant-id: ${{ env.AZURE_TENANT_ID }}
        solution-name: ${{ github.event.inputs.solution_name }}
        solution-output-file: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
        managed: true


    - name: List exported managed package
      run: |
        echo "Listing managed folder contents:"
        ls -la "${{ env.MANAGED_FOLDER }}" || true
        echo "Path used for solution zip: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}"


    # -----------------------
    # UNPACK the managed ZIP on the runner
    # -----------------------
    - name: Unpack managed solution zip (unzip)
      id: unpack
      run: |
        MANAGED_ZIP="${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}"
        echo "Unpacking $MANAGED_ZIP to ${{ env.UNPACKED_FOLDER }}"
        if [ ! -f "$MANAGED_ZIP" ]; then
          echo "ERROR: Managed ZIP not found at $MANAGED_ZIP"
          ls -la "${{ env.MANAGED_FOLDER }}" || true
          exit 1
        fi
        # try a plain unzip first (most PAC exported zips are standard zips)
        unzip -q "$MANAGED_ZIP" -d "${{ env.UNPACKED_FOLDER }}" || {
          echo "unzip failed â€” attempting pac solution unpack (if available)"
          # fallback to pac solution unpack if installed by actions-install
          pac solution unpack --zipfile "$MANAGED_ZIP" --folder "${{ env.UNPACKED_FOLDER }}" || {
            echo "ERROR: both unzip and pac solution unpack failed"; exit 2;
          }
        }
        echo "Unpack complete. Listing unpacked folder:"
        ls -la "${{ env.UNPACKED_FOLDER }}" || true

    # Optional: inspect a couple of typical files (small debug)
    - name: Show a few unpacked items (debug)
      run: |
        echo "Top-level of unpacked:"
        ls -la "${{ env.UNPACKED_FOLDER }}" | sed -n '1,200p' || true
        echo "If Customizations.xml present, show head:"
        if [ -f "${{ env.UNPACKED_FOLDER }}/Customizations.xml" ]; then
          head -n 40 "${{ env.UNPACKED_FOLDER }}/Customizations.xml"
        fi


    - name: Authenticate to Test (service principal)
      run: |
        "$POWERPLATFORMTOOLS_PACPATH" auth create --kind serviceprincipal \
          --url "${{ env.DEV_ENV_URL }}" \
          --tenant "${{ secrets.PP_TENANT_ID }}" \
          --applicationId "${{ secrets.PP_CLIENT_ID }}" \
          --clientSecret "${{ secrets.PP_CLIENT_SECRET }}"
          --name "ci-test-sp" \
          || ( echo "pac auth create failed" && exit 1 )
    
        echo "Authenticated (created profile 'ci-test-sp')"
    
        "$POWERPLATFORMTOOLS_PACPATH" auth who

    - name: List connections (JSON format)
      run: |
        "$POWERPLATFORMTOOLS_PACPATH" connection list --environment "$DEV_ENV_URL" --json | tee connections.json || echo "pac connection list --json failed"
    
    - name: List connections (verbose)
      run: |
        "$POWERPLATFORMTOOLS_PACPATH" connection list --environment "$DEV_ENV_URL" --verbose || echo "pac connection list --verbose failed"

#    - name: Authenticate PAC CLI to DEV Environment
#      run: |
#        set -e
#        set -x
#        echo "===[ Authenticating PAC CLI to DEV Environment ]==="
#        "$POWERPLATFORMTOOLS_PACPATH" auth create \
#          --url "${{ env.DEV_ENV_URL }}" \
#          --tenant "${{ secrets.PP_TENANT_ID }}" \
#          --applicationId "${{ secrets.PP_CLIENT_ID }}" \
#          --clientSecret "${{ secrets.PP_CLIENT_SECRET }}"
#        echo "--- Authentication Complete ---"
#        AUTH_EXIT_CODE=$?
#        echo "--- Authentication Complete (exit code: $AUTH_EXIT_CODE) ---"

#    - name: List All Power Platform Connections (Pretty Print)
#      run: |
#        set -e
#        set -x
#        echo "===[ Listing All Connections in Dev Environment ]==="
#        "$POWERPLATFORMTOOLS_PACPATH" connection list --json > allconns.json
#        PAC_EXIT_CODE=$?
#        echo "--- PAC CLI list exit code: $PAC_EXIT_CODE ---"
#        echo
#        echo "===[ Raw Connections Output Follows ]==="
#        cat allconns.json
#        echo
#        echo "===[ Connections Output (Pretty Printed) ]==="
#        jq . allconns.json
#        JQ_EXIT_CODE=$?
#        echo "--- jq exit code: $JQ_EXIT_CODE ---"  

#    - name: Import Solution
#      uses: microsoft/powerplatform-actions/import-solution@v1
#      with:
#        environment-url: 'https://orgd93932c9.crm.dynamics.com'
#        tenant-id: ${{ secrets.PP_TENANT_ID }}
#        app-id: ${{ secrets.PP_CLIENT_ID }}
#        client-secret: ${{ secrets.PP_CLIENT_SECRET }}
#        solution-file: './exported/managed/solutionone.managed.zip'    # <- Correct file path!
#        run-asynchronously: true
#        force-overwrite: true
#        publish-changes: true
        
#    - name: Show PAC install directory contents
#      run: |
#        echo "PAC path: $POWERPLATFORMTOOLS_PACPATH"
#        ls -R "$POWERPLATFORMTOOLS_PACPATH"  
        
#    - name: Search entire /tmp for pac
#      run: find /tmp -name pac -type f -perm -u+x    

#    - name: Where is pac?
#      run: which pac || echo "pac not found"
      
#    - name: Add Power Platform CLI to PATH
#      run: echo "/tmp/powerplatform-actions-ZVUi5H/pac" >> $GITHUB_PATH
      
#    - name: Generate deployment settings
#      run: |
#        pac solution create-settings \
#          --solution-zip out/solutionone.zip \
#          out/solutionone_deploymentsettings.json
          
#    - name: List connections in Target
#      run: |
#        pac connection list \
#          --environment ${{ secrets.PP_TEST_ENV_ID }} \
#          --json > out/connections.json

          
   # - name: import Solution
    #  uses: microsoft/powerplatform-actions/import-solution@v1
     # with:
      #  environment-url: 'https://orgd93932c9.crm.dynamics.com'
       # tenant-id: ${{ secrets.PP_TENANT_ID }}
        #app-id: ${{ secrets.PP_CLIENT_ID }}
        #client-secret: ${{ secrets.PP_CLIENT_SECRET }}
        #solution-file: 'out/solutionone.zip'
        #run-asynchronously: true
        #force-overwrite: true
        #publish-changes: true
