# Code Generated by Sidekick is for learning and experimentation purposes only.
name: Add SPN as System Administrator in Power Platform Env

on:
  workflow_dispatch:
    inputs:
      source_env_url:
        description: "Source environment URL"
        required: true

env:
  AZURE_TENANT_ID: ${{ secrets.PP_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.PP_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.PP_CLIENT_SECRET }}

jobs:
  add-spn-admin:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Power Platform CLI
      uses: microsoft/powerplatform-actions/actions-install@v1

    - name: Authenticate to SOURCE environment
      run: |
        "$POWERPLATFORMTOOLS_PACPATH" auth create \
          --name source \
          --applicationId "$AZURE_CLIENT_ID" \
          --clientSecret "$AZURE_CLIENT_SECRET" \
          --tenant "$AZURE_TENANT_ID" \
          --environment "${{ inputs.source_env_url }}" \
          --accept-cleartext-caching

    - name: Ensure SPN is System Administrator (SOURCE)
      run: |
        pac admin assign-user \
          --environment "${{ inputs.source_env_url }}" \
          --user "$AZURE_CLIENT_ID" \
          --role "System Administrator"

