name: jqDeploy Setting Workflow - Dev to Test

run-name: deploy_setting

on:
  workflow_dispatch:
    inputs:
      solution_name:
        description: 'Solution unique name (not display name).'
        required: true

env:
  AZURE_TENANT_ID: ${{ secrets.PP_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.PP_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.PP_CLIENT_SECRET }}

  DEV_ENV_URL: 'https://org23b23f97.crm.dynamics.com'
  TEST_ENV_URL: 'https://orgd93932c9.crm.dynamics.com'

  EXPORT_FOLDER: ./exported
  MANAGED_FOLDER: ./exported/managed
  UNPACKED_FOLDER: ./exported/unpacked

  SOLUTION_ZIP_NAME: ${{ github.event.inputs.solution_name }}.zip

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Ensure folders
        run: |
          mkdir -p $EXPORT_FOLDER $MANAGED_FOLDER $UNPACKED_FOLDER

      # -------------------------
      # EXPORT SOLUTION
      # -------------------------
      - name: Export solution from DEV
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ env.DEV_ENV_URL }}
          app-id: ${{ env.AZURE_CLIENT_ID }}
          client-secret: ${{ env.AZURE_CLIENT_SECRET }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          solution-name: ${{ github.event.inputs.solution_name }}
          solution-output-file: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
          managed: false

      # -------------------------
      # UNPACK SOLUTION
      # -------------------------
      - name: Unpack solution
        run: |
          "$POWERPLATFORMTOOLS_PACPATH" solution unpack \
            --zipfile "${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
            --folder "${{ env.UNPACKED_FOLDER }}" \
            --allowDelete

      # -------------------------
      # CREATE SETTINGS.JSON
      # -------------------------
      - name: Create deployment settings
        run: |
          "$POWERPLATFORMTOOLS_PACPATH" solution create-settings \
            --solution-zip "${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
            --settings-file "${{ env.MANAGED_FOLDER }}/settings.json"

      # -------------------------
      # PRINT ALL CONNECTION REFERENCES IN SETTINGS
      # -------------------------
      - name: Print ALL connection references
        run: |
          echo "All connection references in solution:"
          jq -r '.ConnectionReferences[].LogicalName' \
            "${{ env.MANAGED_FOLDER }}/settings.json"

      # -------------------------
      # EXTRACT FLOW CONNECTION REFS (LogicalName extraction - FIXED)
      # -------------------------
      - name: Extract FLOW connection references
        run: |
          # Code Generated by Sidekick is for learning and experimentation purposes only.
          WORKFLOW_DIR="${{ env.UNPACKED_FOLDER }}/Workflows"
          OUTPUT="flow-connection-refs.txt"
          if [ -d "$WORKFLOW_DIR" ]; then
            jq -r '
              .properties.connectionReferences // {} |
              to_entries[] |
              .value.connection.connectionReferenceLogicalName // empty
            ' "$WORKFLOW_DIR"/*.json | sort -u > "$OUTPUT"
          else
            touch "$OUTPUT"
          fi
          echo "FLOW connection references (LogicalNames):"
          cat "$OUTPUT"

      # -------------------------
      # DIAGNOSTICS (OPTIONAL - for troubleshooting)
      # -------------------------
      - name: Diagnostic - Explore unpacked flows and settings
        run: |
          # Code Generated by Sidekick is for learning and experimentation purposes only.

          WORKFLOW_DIR="${{ env.UNPACKED_FOLDER }}/Workflows"
          SETTINGS_FILE="${{ env.MANAGED_FOLDER }}/settings.json"

          echo "========== [1] List all JSON files in $WORKFLOW_DIR =========="
          ls -lh "$WORKFLOW_DIR" || echo " (No Workflows directory or files found!)"
          echo ""

          echo "========== [2] Display the first 20 lines of each workflow JSON =========="
          for f in "$WORKFLOW_DIR"/*.json; do
            [ -f "$f" ] || continue
            echo "------ $f ------"
            head -20 "$f"
            echo ""
          done

          echo "========== [3] Search for 'connectionReferences' object in each JSON =========="
          for f in "$WORKFLOW_DIR"/*.json; do
            [ -f "$f" ] || continue
            echo "------ $f ------"
            grep -A 8 -B 2 '"connectionReferences"' "$f" || echo " (No connectionReferences found)"
            echo ""
          done

          echo "========== [4] Extract all connectionReferenceLogicalName fields =========="
          for f in "$WORKFLOW_DIR"/*.json; do
            [ -f "$f" ] || continue
            echo "------ $f ------"
            jq -r '
              .properties.connectionReferences // {} |
              to_entries[] |
              "Key: " + .key + "  logicalName: " + (.value.connection.connectionReferenceLogicalName // "N/A")
            ' "$f" || echo "(Not a valid JSON or no logicalName fields found)"
            echo ""
          done

          echo "========== [5] Print all connection references from settings.json =========="
          if [ -e "$SETTINGS_FILE" ]; then
            jq -r '
              .ConnectionReferences[]
              | "LogicalName: " + .LogicalName
                + "  ConnectorId: " + .ConnectorId
                + (if .DisplayName then "  DisplayName: " + .DisplayName else "" end)
            ' "$SETTINGS_FILE"
          else
            echo " (settings.json not found!)"
          fi

      # -------------------------
      # AUTH TEST ENV
      # -------------------------
      - name: Authenticate to TEST
        run: |
          "$POWERPLATFORMTOOLS_PACPATH" auth create \
            --name test \
            --applicationId "${{ env.AZURE_CLIENT_ID }}" \
            --clientSecret "${{ env.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ env.AZURE_TENANT_ID }}" \
            --environment "${{ env.TEST_ENV_URL }}" \
            --accept-cleartext-caching

          "$POWERPLATFORMTOOLS_PACPATH" auth select --name test

      # -------------------------
      # PATCH ONLY FLOW CONNECTION REFS
      # -------------------------
      - name: Patch ONLY flow connection refs
        run: |
          # Code Generated by Sidekick is for learning and experimentation purposes only.
          SETTINGS="${{ env.MANAGED_FOLDER }}/settings.json"
          TMP="${SETTINGS}.tmp"
          cp "$SETTINGS" "$TMP"
          while read REF; do
            [ -z "$REF" ] && continue
            echo "Patching FLOW ref: $REF"
            IDX=$(jq -r --arg r "$REF" '
              .ConnectionReferences | to_entries[]
              | select(.value.LogicalName==$r) | .key
            ' "$SETTINGS")
            [ -z "$IDX" ] && continue
            CONN_ID=$("$POWERPLATFORMTOOLS_PACPATH" connection list \
              --environment "${{ env.TEST_ENV_URL }}" \
              | grep "$REF" | awk '{print $1}' | head -n1)
            [ -z "$CONN_ID" ] && continue
            jq --arg id "$CONN_ID" --argjson i "$IDX" \
              '.ConnectionReferences[$i].ConnectionId=$id' \
              "$TMP" > "$TMP.2" && mv "$TMP.2" "$TMP"
          done < flow-connection-refs.txt
          mv "$TMP" "$SETTINGS"
          cat "$SETTINGS"

      # -------------------------
      # IMPORT SOLUTION
      # -------------------------
      - name: Import solution to TEST
        uses: microsoft/powerplatform-actions/import-solution@v1
        with:
          environment-url: ${{ env.TEST_ENV_URL }}
          app-id: ${{ env.AZURE_CLIENT_ID }}
          client-secret: ${{ env.AZURE_CLIENT_SECRET }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          solution-file: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
          deployment-settings-file: ${{ env.MANAGED_FOLDER }}/settings.json
