name: Export and Prep Solution

on:
  workflow_call:
    inputs:
      solution_name: { required: true, type: string }
      dev_env_url: { required: true, type: string }
      export_folder: { required: true, type: string }
      managed_folder: { required: true, type: string }
      unmanaged_folder: { required: true, type: string }
      unpacked_folder: { required: true, type: string }
      azure_tenant_id: { required: true, type: string }
      azure_client_id: { required: true, type: string }
      azure_client_secret: { required: true, type: string }

jobs:
  export:
    runs-on: ubuntu-latest
    env:
      DEV_ENV_URL: ${{ inputs.dev_env_url }}
      EXPORT_FOLDER: ${{ inputs.export_folder }}
      MANAGED_FOLDER: ${{ inputs.managed_folder }}
      UNMANAGED_FOLDER: ${{ inputs.unmanaged_folder }}
      UNPACKED_FOLDER: ${{ inputs.unpacked_folder }}
      AZURE_TENANT_ID: ${{ inputs.azure_tenant_id }}
      AZURE_CLIENT_ID: ${{ inputs.azure_client_id }}
      AZURE_CLIENT_SECRET: ${{ inputs.azure_client_secret }}
      SOLUTION_ZIP_NAME: ${{ inputs.solution_name }}.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Ensure folders
        run: |
          mkdir -p $EXPORT_FOLDER $MANAGED_FOLDER $UNMANAGED_FOLDER $UNPACKED_FOLDER

      - name: Export Unmanaged solution from DEV
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ env.DEV_ENV_URL }}
          app-id: ${{ env.AZURE_CLIENT_ID }}
          client-secret: ${{ env.AZURE_CLIENT_SECRET }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          solution-name: ${{ inputs.solution_name }}
          solution-output-file: ${{ env.UNMANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
          managed: false

      - name: Export Managed solution from DEV
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ env.DEV_ENV_URL }}
          app-id: ${{ env.AZURE_CLIENT_ID }}
          client-secret: ${{ env.AZURE_CLIENT_SECRET }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          solution-name: ${{ inputs.solution_name }}
          solution-output-file: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
          managed: true

      - name: Unpack Unmanaged solution
        run: |
          "$POWERPLATFORMTOOLS_PACPATH" solution unpack \
            --zipfile "${{ env.UNMANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
            --folder "${{ env.UNPACKED_FOLDER }}/Unmanaged" \
            --allowDelete

      - name: Unpack Managed solution
        run: |
          "$POWERPLATFORMTOOLS_PACPATH" solution unpack \
            --zipfile "${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
            --folder "${{ env.UNPACKED_FOLDER }}/Managed" \
            --allowDelete

      - name: Create deployment settings
        run: |
          "$POWERPLATFORMTOOLS_PACPATH" solution create-settings \
            --solution-zip "${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
            --settings-file "${{ env.MANAGED_FOLDER }}/settings.json"

      - name: Upload all for patch phase
        uses: actions/upload-artifact@v4
        with:
          name: export-for-patch
          path: |
            ${{ env.UNMANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
            ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
            ${{ env.MANAGED_FOLDER }}/settings.json
            ${{ env.UNPACKED_FOLDER }}
