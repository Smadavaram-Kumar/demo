name: deploy setting workflow- dev to test

run-name: deploy_setting


on:
  workflow_dispatch:
    inputs:
      solution_name:
        description: 'Solution unique name (not display name).'
        required: true

env:
  # Azure AD / Service Principal (store as repo secrets)
  AZURE_TENANT_ID: ${{ secrets.PP_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.PP_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.PP_CLIENT_SECRET }}

  # Environments (store as repo secrets)
  DEV_ENV_URL: 'https://org23b23f97.crm.dynamics.com'     # e.g. https://org-<id>.crm.dynamics.com
  TEST_ENV_URL: 'https://orgd93932c9.crm.dynamics.com'

  # Local folder structure on the runner (you can change these)
  EXPORT_FOLDER: ./exported                 # where CLI writes the exported zip(s)
  DEPLOY_FOLDER: ./deploy                   # staging folder used before import
  SOLUTION_FOLDER: ./exported/solutions     # generic solution folder path
  MANAGED_FOLDER: ./exported/managed        # store managed zip here
  UNPACKED_FOLDER: ./exported/unpacked     # unpacked folder (if using pac unpack or unzip)

  # Output zip filename (will use solution_name input + suffix)
  SOLUTION_ZIP_NAME: ${{ github.event.inputs.solution_name }}.managed.zip


jobs:
  first-job:
    runs-on: ubuntu-latest

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        lfs: true

    - name: Ensure folders exist
      run: |
        echo "Creating folder structure on runner..."
        mkdir -p "${{ env.EXPORT_FOLDER }}" "${{ env.MANAGED_FOLDER }}" "${{ env.UNPACKED_FOLDER }}" "${{ env.DEPLOY_FOLDER }}"
        ls -la

    - name: Install Power Platform CLI / Tools
      # installs the pac wrapper and related tooling used by the export/import actions
      uses: microsoft/powerplatform-actions/actions-install@v1


    #- name: Create output directory
    #  run: mkdir -p out
      
    # -----------------------
    # EXPORT (Dev) -> Managed ZIP
    # -----------------------
    - name: Export managed solution from Dev
      uses: microsoft/powerplatform-actions/export-solution@v1
      with:
        environment-url: ${{ env.DEV_ENV_URL }}
        app-id: ${{ env.AZURE_CLIENT_ID }}
        client-secret: ${{ env.AZURE_CLIENT_SECRET }}
        tenant-id: ${{ env.AZURE_TENANT_ID }}
        solution-name: ${{ github.event.inputs.solution_name }}
        solution-output-file: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
        managed: false

    - name: List exported managed package
      run: |
        echo "Listing managed folder contents:"
        ls -la "${{ env.MANAGED_FOLDER }}" || true
        echo "Path used for solution zip: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}"

    - name: Validate flows do NOT contain hardcoded connections (Place-2 check)
      shell: bash
      run: |
        set -euo pipefail

        ZIP="${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}"
        UNPACK="${{ env.UNPACKED_FOLDER }}"

        echo "Unpacking solution to inspect flow JSON..."
        rm -rf "$UNPACK"
        mkdir -p "$UNPACK"
        unzip -q "$ZIP" -d "$UNPACK"

        echo "Scanning workflows for hidden connectionIds..."
        BAD_FILES=$(grep -R "\"connectionId\"" "$UNPACK/Workflows" || true)

        if [ -n "$BAD_FILES" ]; then
          echo "ERROR: Hardcoded flow-level connections found!"
          echo "These flows contain Place-2 connections:"
          echo "$BAD_FILES"
          echo ""
          echo "Fix required in DEV:"
          echo " - Open the flow"
          echo " - Rebind to Connection Reference"
          echo " - Save"
          echo " - Turn OFF → ON"
          echo " - Re-export solution"
          exit 1
        else
          echo "PASS: No hidden flow-level connections found."
        fi


    - name: Generate deployment settings file for solution
      run: |
        echo "Creating deployment settings JSON from managed solution..."
        "$POWERPLATFORMTOOLS_PACPATH" solution create-settings \
          --solution-zip "${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
          --settings-file "${{ env.MANAGED_FOLDER }}/settings.json"


    - name: Display settings.json contents
      run: cat ${{ env.MANAGED_FOLDER }}/settings.json


    #- name: Install jq for JSON processing
    #  run: |
    #    sudo apt-get update
    #    sudo apt-get install -y jq

    #- name: Check Power Platform CLI version supports JSON output
    #  run: |
    #    RAW_VERSION=$("$POWERPLATFORMTOOLS_PACPATH" --version)
    #    echo "Power Platform CLI raw version: $RAW_VERSION"
     #   CLI_VERSION=$(echo "$RAW_VERSION" | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')
     #   echo "Power Platform CLI parsed version: $CLI_VERSION"
     #   REQUIRED_VERSION="1.10.4"
     #   if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$CLI_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
     #     echo "ERROR: Power Platform CLI version must be at least $REQUIRED_VERSION for JSON output support."
     #     exit 1
     #   fi

   # - name: Authenticate pac to TEST environment
    #  run: |
    #    "$POWERPLATFORMTOOLS_PACPATH" auth create --name "ci-test-spn" \
    #      --applicationId "${{ env.AZURE_CLIENT_ID }}" \
    #      --clientSecret "${{ env.AZURE_CLIENT_SECRET }}" \
    #      --tenant "${{ env.AZURE_TENANT_ID }}" \
    #      --environment "${{ env.TEST_ENV_URL }}" \
    #      --accept-cleartext-caching
    #    "$POWERPLATFORMTOOLS_PACPATH" auth select --name "ci-test-spn" || true

   # - name: Retrieve connections as JSON from TEST environment
   #   run: |
   #     CONNECTIONS_JSON=$("$POWERPLATFORMTOOLS_PACPATH" connection list \
   #       --environment "${{ env.TEST_ENV_URL }}" \
   #       --output json)
   #     echo "$CONNECTIONS_JSON" > connections.json

#    - name: Extract and display only connectionId values
#      run: |
#        cat connections.json | jq -r '.[].connectionId'



    # --- after your existing steps that generate settings.json ---
    - name: Authenticate to target (TEST) environment
      run: |
        echo "Authenticating pac to TEST environment..."
        "$POWERPLATFORMTOOLS_PACPATH" auth create --name "ci-test-spn" \
          --applicationId "${{ env.AZURE_CLIENT_ID }}" \
          --clientSecret "${{ env.AZURE_CLIENT_SECRET }}" \
          --tenant "${{ env.AZURE_TENANT_ID }}" \
          --environment "${{ env.TEST_ENV_URL }}"\
          --accept-cleartext-caching
  
        # select the auth profile (optional, ensures subsequent pac commands target TEST)
        "$POWERPLATFORMTOOLS_PACPATH" auth list
        "$POWERPLATFORMTOOLS_PACPATH" auth select --name "ci-test-spn" || true


         echo "Listing all connections in TEST environment..."
        "$POWERPLATFORMTOOLS_PACPATH" connection list --environment "${{ env.TEST_ENV_URL }}"


#    - name: List all connections (as JSON) in TEST environment
#      run: |
#        echo "Getting all connections in TEST..."
#        "$POWERPLATFORMTOOLS_PACPATH" connection list --environment "${{ env.TEST_ENV_URL }}" --output json > exported/managed/test-connections.json
#        cat exported/managed/test-connections.json
  
    - name: Query connection IDs from target environment and patch settings.json
      shell: bash
      run: |
        # Code Generated by Sidekick is for learning and experimentation purposes only.
        set -euo pipefail
        
        MANAGED_FOLDER="${{ env.MANAGED_FOLDER }}"
        UNPACKED_FOLDER="${{ env.UNPACKED_FOLDER }}"
        SETTINGS_FILE="$MANAGED_FOLDER/settings.json"
        
        echo "Settings before patch:"
        cat "$SETTINGS_FILE" || true
        
        if ! command -v jq >/dev/null 2>&1; then
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
        fi
        
        # ------- FIND ALL FLOW CONNECTION REF NAMES -------
        FLOW_REFS=()
        for wf in $(find "$UNPACKED_FOLDER/Workflows" -type f -name "*.json" 2>/dev/null); do
          refs=$(jq -r '.properties.connectionReferences | keys[]?' "$wf" || true)
          for r in $refs; do
            FLOW_REFS+=("$r")
          done
        done
        # De-duplicate
        FLOW_REFS=($(printf "%s\n" "${FLOW_REFS[@]}" | sort -u))
        
        echo "-------- FLOW CONNECTION REFS (used by workflows) --------"
        if [ "${#FLOW_REFS[@]}" -eq 0 ]; then
          echo "None found! (Are your flows present under Workflows/?)"
        else
          for f in "${FLOW_REFS[@]}"; do
            echo " • $f"
          done
        fi
        
        # ------- FIND ALL AGENT/NON-FLOW CONNECTION REF NAMES -------
        settings_refs=()
        refs_count=$(jq '.ConnectionReferences | length' "$SETTINGS_FILE")
        for i in $(seq 0 $((refs_count - 1))); do
          logicalName=$(jq -r ".ConnectionReferences[$i].LogicalName" "$SETTINGS_FILE")
          settings_refs+=("$logicalName")
        done
        
        # Print only those settings refs NOT used by flows = AGENT refs
        AGENT_REFS=()
        for s in "${settings_refs[@]}"; do
          found=false
          for f in "${FLOW_REFS[@]}"; do
            if [[ "$s" == "$f" ]]; then
              found=true
              break
            fi
          done
          if [ "$found" = false ]; then
            AGENT_REFS+=("$s")
          fi
        done
        
        echo "-------- AGENT (NON-FLOW) CONNECTION REFS in settings.json --------"
        if [ "${#AGENT_REFS[@]}" -eq 0 ]; then
          echo "None found! Every connection reference is used by a workflow."
        else
          for a in "${AGENT_REFS[@]}"; do
            echo " • $a"
          done
        fi
        
        # ------- PATCH ONLY FLOW CONNECTION REFS --------
        TMP="$MANAGED_FOLDER/settings.tmp.json"
        cp "$SETTINGS_FILE" "$TMP"
        
        for i in $(seq 0 $((refs_count - 1))); do
          logicalName=$(jq -r ".ConnectionReferences[$i].LogicalName" "$SETTINGS_FILE")
          connectorId=$(jq -r ".ConnectionReferences[$i].ConnectorId" "$SETTINGS_FILE")
        
          # Only patch if used in a flow
          PATCH=false
          for f in "${FLOW_REFS[@]}"; do
            if [[ "$logicalName" == "$f" ]]; then
              PATCH=true
              break
            fi
          done
          if [ "$PATCH" = false ]; then
            echo "Skipping agent or non-flow reference: $logicalName"
            continue
          fi
        
          echo "Processing flow connection reference: $logicalName (connectorId=$connectorId)"
          conn_list=$("$POWERPLATFORMTOOLS_PACPATH" connection list --environment "${{ env.TEST_ENV_URL }}" 2>/dev/null || true)
          match_line=$(echo "$conn_list" | grep -i "$connectorId" | head -n1 || true)
          first_token=$(echo "$match_line" | awk '{print $1}' | tr -d '[:space:]' | tr -d '\r' || true)
          found_conn_id="$first_token"
          if [ -n "$found_conn_id" ]; then
            echo "Found connection id for $logicalName -> $found_conn_id. Patching settings.json..."
            jq --arg id "$found_conn_id" --argjson idx "$i" \
              '.ConnectionReferences[$idx].ConnectionId = $id' "$TMP" > "${TMP}.2" && mv "${TMP}.2" "$TMP"
          else
            echo "WARNING: could not find connection id for $logicalName in target environment."
          fi
        done
        
        mv "$TMP" "$SETTINGS_FILE"
        echo "Settings after patch:"
        cat "$SETTINGS_FILE"


# way2 of importing
#    - name: Import managed solution into TEST using patched settings
#      run: |
#        echo "Importing solution to TEST using patched settings.json..."
#        "$POWERPLATFORMTOOLS_PACPATH" solution import \
#          --path "${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
#          --settings-file "${{ env.MANAGED_FOLDER }}/settings.json" \
#          --environment "${{ env.TEST_ENV_URL }}"




    - name: Import solution using pac CLI
      run: |
        "$POWERPLATFORMTOOLS_PACPATH" auth create \
          --applicationId "${{ env.AZURE_CLIENT_ID }}" \
          --clientSecret "${{ env.AZURE_CLIENT_SECRET }}" \
          --tenant "${{ env.AZURE_TENANT_ID }}" \
          --environment "${{ env.TEST_ENV_URL }}"
    
        "$POWERPLATFORMTOOLS_PACPATH" solution import \
          --path "${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}" \
          --settings-file "${{ env.MANAGED_FOLDER }}/settings.json" \
          --force-overwrite



    - name: Import managed solution to TEST (with settings)
      uses: microsoft/powerplatform-actions/import-solution@v1
      with:
        environment-url: ${{ env.TEST_ENV_URL }}
        
        # SPN authentication
        app-id: ${{ env.AZURE_CLIENT_ID }}
        client-secret: ${{ env.AZURE_CLIENT_SECRET }}
        tenant-id: ${{ env.AZURE_TENANT_ID }}
        
        # Solution package
        solution-file: ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
        
        # Deployment settings file
        deployment-settings-file: ${{ env.MANAGED_FOLDER }}/settings.json
        
        # Recommended flags
        async: true
        max-async-wait-time: 60
        force-overwrite: true
        publish-changes: true

    
