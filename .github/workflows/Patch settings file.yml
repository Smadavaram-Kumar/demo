name: Patch settings file

on:
  workflow_call:
    inputs:
      solution_name: { required: true, type: string }
      managed_folder: { required: true, type: string }
      unpacked_folder: { required: true, type: string }
      test_env_url: { required: true, type: string }
      azure_tenant_id: { required: true, type: string }
      azure_client_id: { required: true, type: string }
      azure_client_secret: { required: true, type: string }

jobs:
  patch:
    runs-on: ubuntu-latest
    env:
      MANAGED_FOLDER: ${{ inputs.managed_folder }}
      UNPACKED_FOLDER: ${{ inputs.unpacked_folder }}
      SOLUTION_ZIP_NAME: ${{ inputs.solution_name }}.zip
      TEST_ENV_URL: ${{ inputs.test_env_url }}
      AZURE_TENANT_ID: ${{ inputs.azure_tenant_id }}
      AZURE_CLIENT_ID: ${{ inputs.azure_client_id }}
      AZURE_CLIENT_SECRET: ${{ inputs.azure_client_secret }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download for patch
        uses: actions/download-artifact@v4
        with:
          name: export-for-patch
          path: . # will pull managed/unmanaged/settings.json/unpacked

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Patch ONLY flow connection refs
        run: |
          # Code Generated by Sidekick is for learning and experimentation purposes only.

          set -euo pipefail

          WORKFLOW_DIR="${{ env.UNPACKED_FOLDER }}/Unmanaged/Workflows"
          SETTINGS_FILE="${{ env.MANAGED_FOLDER }}/settings.json"
          TEST_ENV_URL="${{ env.TEST_ENV_URL }}"
          PAC="$POWERPLATFORMTOOLS_PACPATH"
          FLOW_CONN_REFS="flow-connection-refs.txt"

          if [ -d "$WORKFLOW_DIR" ]; then
            jq -r '
              .properties.connectionReferences // {} |
              to_entries[] |
              .value.connection.connectionReferenceLogicalName // empty
            ' "$WORKFLOW_DIR"/*.json | sort -u > "$FLOW_CONN_REFS"
          else
            touch "$FLOW_CONN_REFS"
          fi

          echo "Flow logical names to patch:"
          cat "$FLOW_CONN_REFS"

          # Step 2: List target env connections
          CONN_LIST_OUT="test-connections.txt"
          $PAC connection list --environment "$TEST_ENV_URL" > "$CONN_LIST_OUT"
          echo "Connections pulled from target env:"
          cat "$CONN_LIST_OUT"

          # Step 3: Patch settings.json in place
          TMP="$SETTINGS_FILE.tmp"
          cp "$SETTINGS_FILE" "$TMP"

          while read FLOW_LOGICAL; do
            [ -z "$FLOW_LOGICAL" ] && continue
            echo "Processing flow logical: $FLOW_LOGICAL"
            IDX=$(jq -r --arg r "$FLOW_LOGICAL" '
              .ConnectionReferences | to_entries[]
              | select(.value.LogicalName==$r) | .key' "$SETTINGS_FILE")
            [ -z "$IDX" ] && { echo "  Not found in settings.json, skipping."; continue; }
            CONNECTOR_ID=$(jq -r --argjson i "$IDX" '.ConnectionReferences[$i].ConnectorId' "$SETTINGS_FILE")
            CONNECTOR_TOKEN=$(basename "$CONNECTOR_ID")
            echo "  Searching for test connection for connector: $CONNECTOR_TOKEN"
            MATCH_LINE=$(grep -i "$CONNECTOR_ID" "$CONN_LIST_OUT" | head -n1 || true)
            FOUND_CONN_ID=$(echo "$MATCH_LINE" | awk '{print $1}' | tr -d '[:space:]' | tr -d '\r' || true)
            if [ -n "$FOUND_CONN_ID" ]; then
              echo "  Found connection id: $FOUND_CONN_ID"
              jq --arg id "$FOUND_CONN_ID" --argjson i "$IDX" \
                '.ConnectionReferences[$i].ConnectionId = $id' "$TMP" > "${TMP}.2" && mv "${TMP}.2" "$TMP"
            else
              echo "  WARNING: No matching connection id found for $CONNECTOR_TOKEN. Will remain blank."
            fi
          done < "$FLOW_CONN_REFS"
          mv "$TMP" "$SETTINGS_FILE"
          echo "Patched settings file:"
          cat "$SETTINGS_FILE"

      - name: Upload patched for import
        uses: actions/upload-artifact@v4
        with:
          name: patched-for-import
          path: |
            ${{ env.MANAGED_FOLDER }}/${{ env.SOLUTION_ZIP_NAME }}
            ${{ env.MANAGED_FOLDER }}/settings.json
